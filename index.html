<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>weather app</title>
  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" 
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="index.css">
  </head>
  <body>

    <div class="searchbar ">
      <div class="searchbarparentDiv">
        <input type="text" class="inputfield" placeholder="Search city">
        <img src="https://static.vecteezy.com/system/resources/thumbnails/009/652/218/small_2x/magnifying-glass-icon-isolated-on-white-background-search-illustration-vector.jpg" alt="search icon" width="35px" class="searchIcon" onclick="fetchData()">
      </div>
    </div>

    <div class="mainContentParentDiv d-flex ">

      <div class="leftdiv">

        <div class="currenttemperaturediv glass leftchild  p-3 d-flex flex-column gap-2"> 
          <h6 class="m-0" id="cityname">City name</h6>
          <h5 class="m-0" id="citytemp">0 &deg;C</h5>
          <h6 class="m-0" id="skydesc">Sky description</h6>
          <hr class="line">
          <div class="d-flex gap-2">
            <img src="https://p7.hiclipart.com/preview/253/892/941/computer-icons-calendar-date-event-table.jpg" alt="calendar" width="25px">
            <h6 class="m-0" id="date">Date</h6>
          </div>
          <div class="d-flex gap-2"> <!--rowwise with gap 2-->
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSX71Ma8BzA_aZCVoM1s2z6hyijGLcKbqm5CQ&s" alt="time" width="25px" height="25px">
            <h6 class="m-0" id="time">Time</h6>
          </div>
        </div>

        <div class="nextfivedays glass leftchild p-3 d-flex flex-column gap-4">
          <h6 class="m-0" id="comingfivedaysid">Coming five days</h6>

          <div id="forecastContainer" class="d-flex flex-column gap-2">
            <div class="forecastRow d-flex align-items-center justify-content-between">
             <div class="d-flex gap-1 align-items-center">
                <img src="https://cdn-icons-png.flaticon.com/512/5994/5994882.png" alt="" width="35px">
                <h6>- &deg;C</h6>           
              </div>            
                <h6 class="m-0">day</h6>
                <h6 class="m-0" >date</h6>
            </div>

            <div class="forecastRow d-flex align-items-center justify-content-between">
             <div class="d-flex gap-1 align-items-center">
                <img src="https://cdn-icons-png.flaticon.com/512/5994/5994882.png" alt="" width="35px">
                <h6>- &deg;C</h6>           
              </div>            
                <h6 class="m-0">day</h6>
                <h6 class="m-0" >date</h6>
            </div>

            <div class="forecastRow d-flex align-items-center justify-content-between">
             <div class="d-flex gap-1 align-items-center">
                <img src="https://cdn-icons-png.flaticon.com/512/5994/5994882.png" alt="" width="35px">
                <h6>- &deg;C</h6>           
              </div>            
                <h6 class="m-0">day</h6>
                <h6 class="m-0" >date</h6>
            </div>

            <div class="forecastRow d-flex align-items-center justify-content-between">
             <div class="d-flex gap-1 align-items-center">
                <img src="https://cdn-icons-png.flaticon.com/512/5994/5994882.png" alt="" width="35px">
                <h6>- &deg;C</h6>           
              </div>            
                <h6 class="m-0">day</h6>
                <h6 class="m-0" >date</h6>
            </div>

            <div class="forecastRow d-flex align-items-center justify-content-between">
             <div class="d-flex gap-1 align-items-center">
                <img src="https://cdn-icons-png.flaticon.com/512/5994/5994882.png" alt="" width="35px">
                <h6>- &deg;C</h6>           
              </div>            
                <h6 class="m-0">day</h6>
                <h6 class="m-0" >date</h6>
            </div>
          </div>
        </div>
      </div>

      <div class="rightdiv d-flex flex-column gap-2">

        <div class="rightrow rowone d-flex gap-2 justify-content-between align-items-center">

          <div class="extrametric glass d-flex gap-3">
            <img src="https://cdn-icons-png.flaticon.com/512/1108/1108593.png" alt="" width="35px">
            <div>
              <h6 class="m-0">Humidity</h6>
              <h6 class="m-0" id="humidity">-</h6>
            </div>
          </div>

          <div class="extrametric glass d-flex gap-3">
            <img src="https://cdn-icons-png.flaticon.com/512/1108/1108593.png" alt="" width="35px">
            <div>
              <h6 class="m-0">Pressure</h6>
              <h6 class="m-0" id="Pressure">-</h6>
            </div>
          </div>

          <div class="extrametric glass d-flex gap-3">
            <img src="https://cdn-icons-png.flaticon.com/512/1108/1108593.png" alt="" width="35px">
            <div>
              <h6 class="m-0">Feels like</h6>
              <h6 class="m-0" id="feelslike">-</h6>
            </div>
          </div>


          <div class="extrametric glass d-flex gap-3">
            <img src="https://cdn-icons-png.flaticon.com/512/1108/1108593.png" alt="" width="35px">
            <div>
              <h6 class="m-0">Visibility</h6>
              <h6 class="m-0" id="visibility">-</h6>
            </div>
          </div>

        </div>

        <div class="rightrow rowtwo d-flex justify-content-between align-items-center">

          <div class="AQI glass rowtwodiv p-3 d-flex flex-column gap-3 ">
            <h5>Air Quality Index (AQI)</h5>
            <div class="d-flex gap-5 align-items-center">
              <img src="https://cdn-icons-png.flaticon.com/512/4005/4005837.png" alt="" width="55px" height="55px">
              <div>
                <h6>CO</h6>
                <h6 id="covalue">-</h6>
              </div>
              <div>
                <h6>SO2</h6>
                <h6 id="so2value">-</h6>
              </div>
                <div>
                <h6>NO2</h6>
                <h6 id="no2value">-</h6>
              </div>
              <div>
                <h6>O3</h6>
                <h6 id="o3value">-</h6>
              </div>
            </div>
          </div>

          <div class="sunrisesunset glass rowtwodiv p-3 d-flex flex-column ">
            <h5 class="m-0">Sunrise & Sunset</h5>

            <div class="d-flex gap-2 justify-content-between ">
              <div class="sunrise d-flex gap-3 align-items-center">
                <img src="https://cdn-icons-png.flaticon.com/512/1788/1788911.png" alt="" width="75px" height="75px">
                <div class="p-2">
                  <h6 class="m-0">Sunrise</h6>
                  <h6 class="m-0" id="sunrisetime">-</h6>
                </div>
              </div>

              <div class="sunset d-flex gap-3 align-items-center">
                <img src="https://cdn-icons-png.flaticon.com/512/1207/1207558.png" alt="" width="75px" height="75px">
                <div class="p-2">
                  <h6 class="m-0">Sunset</h6>
                  <h6 class="m-0" id="sunsettime">-</h6>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="rightrow rowthree d-flex flex-column gap-4">
          <h5 class="m-0">Today</h5>

          <div id="todaytempcontainer" class="d-flex gap-5 ">

            <div class="todaytemp glass">
              <h6>12:00 PM</h6>
              <img src="https://cdn-icons-png.flaticon.com/512/1192/1192396.png" alt="" width="35px">
              <h5>- &deg;C</h5>
            </div>

            <div class="todaytemp glass">
              <h6>3:00 PM</h6>
              <img src="https://cdn-icons-png.flaticon.com/512/1192/1192396.png" alt="" width="35px">
              <h5>- &deg;C</h5>
            </div>

            <div class="todaytemp glass">
              <h6>6:00 PM</h6>
              <img src="https://cdn-icons-png.flaticon.com/512/1192/1192396.png" alt="" width="35px">
              <h5>- &deg;C</h5>
            </div>

            <div class="todaytemp glass">
              <h6>9:00 PM</h6>
              <img src="https://cdn-icons-png.flaticon.com/512/1192/1192396.png" alt="" width="35px">
              <h5>- &deg;C</h5>
            </div>
          </div>
        </div>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js" integrity="sha384-7qAoOXltbVP82dhxHAUje59V5r2YsVfBafyUDxEdApLPmcdhBPg1DKg1ERo0BZlK" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>

      <script>

      function dateFormat(timestamp){
        const date = new Date(timestamp * 1000);        
        return date.toLocaleString();
      }

      async function fetchAQIData(lat, lon){
        let res = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=8f042e4321335d27d1b7d60799ec8de6`);
        let formattedData = await res.json();
        let list = formattedData.list[0].components;

        $("#no2value")[0].innerText = list.no2;
        $("#o3value")[0].innerText = list.o3;
        $("#covalue")[0].innerText = list.co;
        $("#so2value")[0].innerText = list.so2;
      }

      async function nextFiveDays(lat, lon) {
        const apiUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=8f042e4321335d27d1b7d60799ec8de6&units=metric`;
        const response = await fetch(apiUrl);
        const data = await response.json();

        let dailyForecasts = {};

        data.list.forEach(item => {
          let date = item.dt_txt.split(" ")[0];
          if (!dailyForecasts[date]){
           dailyForecasts[date] = {
             temp: item.main.temp.toFixed(1),
             day: new Date(date).toLocaleDateString('en-US', { weekday: 'long' }),
             date: date,
             icon: item.weather[0].icon
            };
          }
        });

        let rows = $("#forecastContainer .forecastRow");

        Object.keys(dailyForecasts).slice(0, 5).forEach((date, idx) => {
          let f = dailyForecasts[date];
          let row = $(rows[idx]);
          // temperature
          row.find("div h6").text(f.temp + "째C");
          // day
          row.find("h6").eq(1).text(f.day);
          // date
          row.find("h6").eq(2).text(f.date);
          // icon
          row.find("img").attr("src", `http://openweathermap.org/img/wn/${f.icon}.png`);
        });
      }

      async function todayTemps(lat, lon){
        try {
          const apiUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=8f042e4321335d27d1b7d60799ec8de6&units=metric`;
          const response = await fetch(apiUrl);
          const data = await response.json();

          // find first forecast entry that is at or after "now" (local time)
          const now = new Date();
          let startIndex = data.list.findIndex(item => new Date(item.dt * 1000) >= now);
          if (startIndex === -1) startIndex = 0; // fallback to start if none >= now

          // take next 4 forecast slots from that index
          const nextFour = data.list.slice(startIndex, startIndex + 4);

          const tempDivs = document.querySelectorAll("#todaytempcontainer .todaytemp");

          // update each .todaytemp card 
          for (let i = 0; i < tempDivs.length; i++) {
            const card = tempDivs[i];
            const slot = nextFour[i];

            // DOM elements 
            const timeElem = card.querySelector("h6");
            const imgElem = card.querySelector("img");
            const tempElem = card.querySelector("h5");

            if (slot) {
             const localDt = new Date(slot.dt * 1000);
             timeElem.innerText = localDt.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
             tempElem.innerText = slot.main.temp.toFixed(1) + "째C";
             imgElem.src = `https://openweathermap.org/img/wn/${slot.weather[0].icon}@2x.png`;
             imgElem.alt = slot.weather[0].description || "";
            } else {
             // placeholder if API doesn't have enough slots
             timeElem.innerText = "--:--";
             tempElem.innerText = "- 째C";
             imgElem.src = "https://cdn-icons-png.flaticon.com/512/1192/1192396.png";
             imgElem.alt = "weather";
            }
          }
        } catch (err) {
         console.error("todayTemps error:", err);
        }
      }

      async function fetchData(){
        let cityName=document.getElementsByClassName('inputfield')[0].value;
        let requestData=await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${cityName}&appid=8f042e4321335d27d1b7d60799ec8de6&units=metric`)
        let formattedData=await requestData.json(); //all the browser data in now in this variable        
        console.log(formattedData); 

        let responseCityName=formattedData.name;
        let responseTemp=formattedData.main.temp;
        let skydescription=formattedData.weather[0].description;
        $('#cityname')[0].innerText=responseCityName;
        $("#citytemp")[0].innerText=responseTemp+" ";
        $('#skydesc')[0].innerText=skydescription;

        //updating date and time
        let properdate=dateFormat(formattedData.dt);
        let date=properdate.split(',')[0]
        let time=properdate.split(',')[1]
        $("#date")[0].innerText=date;
        $("#time")[0].innerText=time;

        //upadting sunrise and sunset
        let sunriseTimeStamp=formattedData.sys.sunrise;
        let sunsetTimeStamp=formattedData.sys.sunset;
        let propersunrise=dateFormat(sunriseTimeStamp).split(',')[1];
        let propersunset=dateFormat(sunsetTimeStamp).split(',')[1];
        $("#sunrisetime")[0].innerText=propersunrise;
        $("#sunsettime")[0].innerText=propersunset;

        let lat=formattedData.coord.lat;
        let lon=formattedData.coord.lon;
        $("#humidity")[0].innerText = formattedData.main.humidity + "%";
        $("#Pressure")[0].innerText = formattedData.main.pressure + " hPa";
        $("#feelslike")[0].innerText = formattedData.main.feels_like.toFixed(1) + "째C";
        $("#visibility")[0].innerText = (formattedData.visibility / 1000).toFixed(1) + " km";

        fetchAQIData(lat,lon);
        nextFiveDays(lat, lon);
        todayTemps(lat, lon);
      }      
    </script>
  </body>
</html>